<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Task 4.1</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .test-wheel {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Integration Test - Task 4.1: Wheel Functionality with Segments</h1>
        
        <div class="test-section">
            <h2>1. Wheel Segment Creation Test</h2>
            <div id="segmentTestResults"></div>
            <div class="test-wheel">
                <div class="roulette-wheel" id="testWheel">
                    <div class="wheel-center">
                        <button id="testSegmentButton" class="spin-button">TEST SEGMENTS</button>
                    </div>
                    <div class="wheel-pointer"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>2. Spin Animation Test</h2>
            <div id="spinTestResults"></div>
            <div class="test-wheel">
                <div class="roulette-wheel" id="spinTestWheel">
                    <div class="wheel-center">
                        <button id="testSpinButton" class="spin-button">TEST SPIN</button>
                    </div>
                    <div class="wheel-pointer"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>3. Result Selection and Highlighting Test</h2>
            <div id="highlightTestResults"></div>
            <div class="test-wheel">
                <div class="roulette-wheel" id="highlightTestWheel">
                    <div class="wheel-center">
                        <button id="testHighlightButton" class="spin-button">TEST HIGHLIGHT</button>
                    </div>
                    <div class="wheel-pointer"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>4. Overall Integration Test</h2>
            <div id="integrationTestResults"></div>
            <button id="runAllTestsButton" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Run All Tests</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Test utilities
        function addTestResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        // Test 1: Segment Creation
        function testSegmentCreation() {
            addTestResult('segmentTestResults', 'Testing segment creation...', 'info');
            
            try {
                const testWheel = document.getElementById('testWheel');
                if (!testWheel) {
                    throw new Error('Test wheel element not found');
                }

                // Create segment creator
                const segmentCreator = new WheelSegmentCreator(testWheel);
                
                // Test with cat images
                const testCats = catManager.getAllCats();
                const segments = segmentCreator.createSegments(testCats);
                
                if (segments.length === testCats.length) {
                    addTestResult('segmentTestResults', `✓ Created ${segments.length} segments successfully`, 'pass');
                } else {
                    addTestResult('segmentTestResults', `✗ Expected ${testCats.length} segments, got ${segments.length}`, 'fail');
                }
                
                // Test segment positioning
                let positioningCorrect = true;
                segments.forEach((segment, index) => {
                    const rotation = segment.getAttribute('data-rotation');
                    const expectedRotation = (360 / testCats.length) * index;
                    if (Math.abs(parseFloat(rotation) - expectedRotation) > 0.1) {
                        positioningCorrect = false;
                    }
                });
                
                if (positioningCorrect) {
                    addTestResult('segmentTestResults', '✓ Segment positioning is correct', 'pass');
                } else {
                    addTestResult('segmentTestResults', '✗ Segment positioning has errors', 'fail');
                }
                
                // Test segment structure
                let structureCorrect = true;
                segments.forEach(segment => {
                    if (!segment.querySelector('.segment-image-container')) {
                        structureCorrect = false;
                    }
                });
                
                if (structureCorrect) {
                    addTestResult('segmentTestResults', '✓ Segment structure is correct', 'pass');
                } else {
                    addTestResult('segmentTestResults', '✗ Segment structure has issues', 'fail');
                }
                
                return true;
                
            } catch (error) {
                addTestResult('segmentTestResults', `✗ Segment creation failed: ${error.message}`, 'fail');
                return false;
            }
        }

        // Test 2: Spin Animation
        function testSpinAnimation() {
            addTestResult('spinTestResults', 'Testing spin animation...', 'info');
            
            return new Promise((resolve) => {
                try {
                    const spinTestWheel = document.getElementById('spinTestWheel');
                    if (!spinTestWheel) {
                        throw new Error('Spin test wheel element not found');
                    }

                    // Create wheel spinner
                    const spinner = new WheelSpinner(spinTestWheel, document.getElementById('testSpinButton'), null);
                    
                    // Initialize segments
                    spinner.initializeSegments().then(() => {
                        addTestResult('spinTestResults', '✓ Segments initialized for spin test', 'pass');
                        
                        // Test spin mechanics
                        const initialRotation = rouletteState.currentRotation;
                        
                        // Mock a spin without full animation
                        const testRotation = RouletteRandomizer.generateSpinRotation();
                        if (testRotation >= 1080 && testRotation <= 2520) {
                            addTestResult('spinTestResults', '✓ Spin rotation generation works correctly', 'pass');
                        } else {
                            addTestResult('spinTestResults', `✗ Invalid spin rotation: ${testRotation}`, 'fail');
                        }
                        
                        // Test selected cat calculation
                        const selectedIndex = RouletteRandomizer.calculateSelectedCat(testRotation, catManager.getAllCats().length);
                        if (selectedIndex >= 0 && selectedIndex < catManager.getAllCats().length) {
                            addTestResult('spinTestResults', '✓ Cat selection calculation works correctly', 'pass');
                        } else {
                            addTestResult('spinTestResults', `✗ Invalid selected index: ${selectedIndex}`, 'fail');
                        }
                        
                        resolve(true);
                        
                    }).catch(error => {
                        addTestResult('spinTestResults', `✗ Segment initialization failed: ${error.message}`, 'fail');
                        resolve(false);
                    });
                    
                } catch (error) {
                    addTestResult('spinTestResults', `✗ Spin animation test failed: ${error.message}`, 'fail');
                    resolve(false);
                }
            });
        }

        // Test 3: Result Selection and Highlighting
        function testResultHighlighting() {
            addTestResult('highlightTestResults', 'Testing result highlighting...', 'info');
            
            return new Promise((resolve) => {
                try {
                    const highlightTestWheel = document.getElementById('highlightTestWheel');
                    if (!highlightTestWheel) {
                        throw new Error('Highlight test wheel element not found');
                    }

                    // Create wheel spinner
                    const spinner = new WheelSpinner(highlightTestWheel, document.getElementById('testHighlightButton'), null);
                    
                    // Initialize segments
                    spinner.initializeSegments().then(() => {
                        addTestResult('highlightTestResults', '✓ Segments initialized for highlight test', 'pass');
                        
                        // Test highlighting functionality
                        const testCat = catManager.getAllCats()[0];
                        spinner.highlightSelectedSegment(testCat);
                        
                        // Check if segment is highlighted
                        const highlightedSegment = highlightTestWheel.querySelector('.wheel-segment.highlighted');
                        if (highlightedSegment) {
                            const catId = highlightedSegment.getAttribute('data-cat-id');
                            if (catId === testCat.id.toString()) {
                                addTestResult('highlightTestResults', '✓ Segment highlighting works correctly', 'pass');
                            } else {
                                addTestResult('highlightTestResults', `✗ Wrong segment highlighted: expected ${testCat.id}, got ${catId}`, 'fail');
                            }
                        } else {
                            addTestResult('highlightTestResults', '✗ No segment was highlighted', 'fail');
                        }
                        
                        // Test clearing highlights
                        spinner.clearSegmentHighlights();
                        const remainingHighlights = highlightTestWheel.querySelectorAll('.wheel-segment.highlighted');
                        if (remainingHighlights.length === 0) {
                            addTestResult('highlightTestResults', '✓ Highlight clearing works correctly', 'pass');
                        } else {
                            addTestResult('highlightTestResults', `✗ ${remainingHighlights.length} highlights remain after clearing`, 'fail');
                        }
                        
                        resolve(true);
                        
                    }).catch(error => {
                        addTestResult('highlightTestResults', `✗ Segment initialization failed: ${error.message}`, 'fail');
                        resolve(false);
                    });
                    
                } catch (error) {
                    addTestResult('highlightTestResults', `✗ Highlight test failed: ${error.message}`, 'fail');
                    resolve(false);
                }
            });
        }

        // Integration test
        async function runIntegrationTest() {
            addTestResult('integrationTestResults', 'Running integration tests...', 'info');
            
            let allPassed = true;
            
            // Test 1: Segment Creation
            const segmentTest = testSegmentCreation();
            if (!segmentTest) allPassed = false;
            
            // Test 2: Spin Animation
            const spinTest = await testSpinAnimation();
            if (!spinTest) allPassed = false;
            
            // Test 3: Result Highlighting
            const highlightTest = await testResultHighlighting();
            if (!highlightTest) allPassed = false;
            
            // Overall result
            if (allPassed) {
                addTestResult('integrationTestResults', '✓ All integration tests passed! Task 4.1 requirements met.', 'pass');
            } else {
                addTestResult('integrationTestResults', '✗ Some integration tests failed. Review the issues above.', 'fail');
            }
            
            return allPassed;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for initialization
            setTimeout(() => {
                // Individual test buttons
                document.getElementById('testSegmentButton').addEventListener('click', testSegmentCreation);
                
                document.getElementById('testSpinButton').addEventListener('click', async () => {
                    await testSpinAnimation();
                });
                
                document.getElementById('testHighlightButton').addEventListener('click', async () => {
                    await testResultHighlighting();
                });
                
                // Run all tests button
                document.getElementById('runAllTestsButton').addEventListener('click', runIntegrationTest);
                
                addTestResult('integrationTestResults', 'Integration test ready. Click "Run All Tests" to begin.', 'info');
                
            }, 1000);
        });
    </script>
</body>
</html>