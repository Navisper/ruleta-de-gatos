<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Roulette Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-results { margin: 20px 0; }
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-section { margin: 15px 0; border-left: 3px solid #ccc; padding-left: 15px; }
        .test-summary { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Cat Roulette Unit Tests</h1>
    <div id="testResults" class="test-results"></div>
    
    <!-- Include the main script -->
    <script src="script.js"></script>
    
    <!-- Test framework -->
    <script>
        // Simple test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }
            
            test(name, testFn) {
                this.tests.push({ name, testFn });
            }
            
            async runAll() {
                const resultsDiv = document.getElementById('testResults');
                let passed = 0;
                let failed = 0;
                
                for (const test of this.tests) {
                    try {
                        await test.testFn();
                        this.results.push({ name: test.name, passed: true });
                        passed++;
                        resultsDiv.innerHTML += `<div class="test-pass">✓ ${test.name}</div>`;
                    } catch (error) {
                        this.results.push({ name: test.name, passed: false, error: error.message });
                        failed++;
                        resultsDiv.innerHTML += `<div class="test-fail">✗ ${test.name}: ${error.message}</div>`;
                    }
                }
                
                resultsDiv.innerHTML += `<div class="test-summary">Tests: ${passed + failed}, Passed: ${passed}, Failed: ${failed}</div>`;
                return { passed, failed, total: passed + failed };
            }
        }
        
        // Test utilities
        function assertEquals(actual, expected, message = '') {
            if (actual !== expected) {
                throw new Error(`${message} Expected: ${expected}, Actual: ${actual}`);
            }
        }
        
        function assertTrue(condition, message = '') {
            if (!condition) {
                throw new Error(`${message} Expected true, got false`);
            }
        }
        
        function assertFalse(condition, message = '') {
            if (condition) {
                throw new Error(`${message} Expected false, got true`);
            }
        }
        
        function assertThrows(fn, message = '') {
            try {
                fn();
                throw new Error(`${message} Expected function to throw, but it didn't`);
            } catch (error) {
                // Expected behavior
            }
        }
    </script>
    
    <!-- Test cases -->
    <script>
        const runner = new TestRunner();
        
        // Test data
        const testCatImages = [
            { id: 1, filename: "cat1.svg", alt: "Test cat 1", weight: 1 },
            { id: 2, filename: "cat2.svg", alt: "Test cat 2", weight: 2 },
            { id: 3, filename: "cat3.svg", alt: "Test cat 3", weight: 1 }
        ];
        
        // CatImageManager Tests
        runner.test('CatImageManager - Constructor initializes correctly', () => {
            const manager = new CatImageManager(testCatImages);
            assertEquals(manager.images.length, 3, 'Should have 3 images');
            assertEquals(manager.totalWeight, 4, 'Total weight should be 4');
        });
        
        runner.test('CatImageManager - calculateTotalWeight works correctly', () => {
            const manager = new CatImageManager(testCatImages);
            assertEquals(manager.calculateTotalWeight(), 4, 'Should calculate total weight as 4');
        });
        
        runner.test('CatImageManager - selectRandomCat returns valid cat', () => {
            const manager = new CatImageManager(testCatImages);
            const selectedCat = manager.selectRandomCat();
            assertTrue(selectedCat !== null, 'Should return a cat');
            assertTrue(testCatImages.some(cat => cat.id === selectedCat.id), 'Should return one of the test cats');
        });
        
        runner.test('CatImageManager - getCatById returns correct cat', () => {
            const manager = new CatImageManager(testCatImages);
            const cat = manager.getCatById(2);
            assertEquals(cat.id, 2, 'Should return cat with id 2');
            assertEquals(cat.filename, "cat2.svg", 'Should return correct filename');
        });
        
        runner.test('CatImageManager - getCatById returns undefined for invalid id', () => {
            const manager = new CatImageManager(testCatImages);
            const cat = manager.getCatById(999);
            assertEquals(cat, undefined, 'Should return undefined for invalid id');
        });
        
        runner.test('CatImageManager - getAllCats returns copy of images', () => {
            const manager = new CatImageManager(testCatImages);
            const allCats = manager.getAllCats();
            assertEquals(allCats.length, 3, 'Should return all cats');
            assertTrue(allCats !== manager.images, 'Should return a copy, not the original array');
        });
        
        runner.test('CatImageManager - updateCatWeight updates weight correctly', () => {
            const manager = new CatImageManager(testCatImages);
            const result = manager.updateCatWeight(1, 5);
            assertTrue(result, 'Should return true for successful update');
            assertEquals(manager.getCatById(1).weight, 5, 'Weight should be updated to 5');
            assertEquals(manager.totalWeight, 8, 'Total weight should be recalculated');
        });
        
        runner.test('CatImageManager - updateCatWeight rejects invalid weight', () => {
            const manager = new CatImageManager(testCatImages);
            const result = manager.updateCatWeight(1, 0);
            assertFalse(result, 'Should return false for invalid weight');
            assertEquals(manager.getCatById(1).weight, 1, 'Weight should remain unchanged');
        });
        
        // RouletteRandomizer Tests
        runner.test('RouletteRandomizer - generateSpinRotation returns valid rotation', () => {
            const rotation = RouletteRandomizer.generateSpinRotation();
            assertTrue(rotation >= 1080, 'Should be at least 3 full rotations (1080 degrees)');
            assertTrue(rotation <= 2520, 'Should be at most 7 full rotations (2520 degrees)');
        });
        
        runner.test('RouletteRandomizer - calculateSelectedCat returns valid index', () => {
            const totalCats = 8;
            const rotation = 450; // 1.25 rotations
            const selectedIndex = RouletteRandomizer.calculateSelectedCat(rotation, totalCats);
            assertTrue(selectedIndex >= 0, 'Should return non-negative index');
            assertTrue(selectedIndex < totalCats, 'Should return index less than total cats');
        });
        
        runner.test('RouletteRandomizer - validateFairDistribution detects equal weights', () => {
            const fairCats = [
                { weight: 1 }, { weight: 1 }, { weight: 1 }
            ];
            assertTrue(RouletteRandomizer.validateFairDistribution(fairCats), 'Should return true for equal weights');
        });
        
        runner.test('RouletteRandomizer - validateFairDistribution detects unequal weights', () => {
            const unfairCats = [
                { weight: 1 }, { weight: 2 }, { weight: 1 }
            ];
            assertFalse(RouletteRandomizer.validateFairDistribution(unfairCats), 'Should return false for unequal weights');
        });
        
        // ImagePreloader Tests
        runner.test('ImagePreloader - Constructor initializes correctly', () => {
            const preloader = new ImagePreloader(testCatImages);
            assertEquals(preloader.images.length, 3, 'Should store images array');
            assertEquals(preloader.loadedImages.size, 0, 'Should start with no loaded images');
            assertEquals(preloader.failedImages.size, 0, 'Should start with no failed images');
        });
        
        runner.test('ImagePreloader - getLoadingStats returns correct initial stats', () => {
            const preloader = new ImagePreloader(testCatImages);
            const stats = preloader.getLoadingStats();
            assertEquals(stats.total, 3, 'Total should be 3');
            assertEquals(stats.loaded, 0, 'Loaded should be 0');
            assertEquals(stats.failed, 0, 'Failed should be 0');
            assertEquals(stats.loading, 0, 'Loading should be 0');
        });
        
        runner.test('ImagePreloader - isImageLoaded returns false initially', () => {
            const preloader = new ImagePreloader(testCatImages);
            assertFalse(preloader.isImageLoaded(1), 'Should return false for unloaded image');
        });
        
        runner.test('ImagePreloader - isImageFailed returns false initially', () => {
            const preloader = new ImagePreloader(testCatImages);
            assertFalse(preloader.isImageFailed(1), 'Should return false for unfailed image');
        });
        
        // Browser compatibility tests
        runner.test('Browser compatibility - checkBrowserCompatibility function exists', () => {
            assertTrue(typeof checkBrowserCompatibility === 'function', 'checkBrowserCompatibility should be a function');
        });
        
        runner.test('Browser compatibility - returns boolean', () => {
            const result = checkBrowserCompatibility();
            assertTrue(typeof result === 'boolean', 'Should return a boolean value');
        });
        
        // Global functions tests
        runner.test('Global functions - showUserFeedback exists', () => {
            assertTrue(typeof showUserFeedback === 'function', 'showUserFeedback should be a function');
        });
        
        runner.test('Global functions - showNetworkStatus exists', () => {
            assertTrue(typeof showNetworkStatus === 'function', 'showNetworkStatus should be a function');
        });
        
        // Roulette state tests
        runner.test('Roulette state - initial state is correct', () => {
            assertEquals(rouletteState.isSpinning, false, 'Should not be spinning initially');
            assertEquals(rouletteState.currentRotation, 0, 'Should start at 0 rotation');
            assertEquals(rouletteState.selectedCat, null, 'Should have no selected cat initially');
            assertEquals(rouletteState.spinDuration, 3000, 'Should have 3 second spin duration');
        });
        
        // Run all tests when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Running Cat Roulette unit tests...');
            const results = await runner.runAll();
            console.log(`Test Results: ${results.passed}/${results.total} passed`);
        });
    </script>
</body>
</html>